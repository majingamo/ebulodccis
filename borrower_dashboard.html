<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Borrower Dashboard — CCIS E-Bulod</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    /* ============================================
       DESIGN SYSTEM - Centralized Design Tokens
       ============================================ */
    :root {
      /* Colors - Primary Palette */
      --color-primary: #002b5c;
      --color-primary-dark: #001a3d;
      --color-primary-light: #004080;
      --color-secondary: #ffb400;
      --color-secondary-dark: #cc9000;
      
      /* Colors - Status Palette */
      --color-success: #10b981;
      --color-success-light: #d1fae5;
      --color-danger: #ef4444;
      --color-danger-light: #fee2e2;
      --color-warning: #f59e0b;
      --color-warning-light: #fef3c7;
      --color-info: #0ea5e9;
      --color-info-light: #e0f2fe;
      
      /* Colors - Neutral Palette */
      --color-bg-primary: #ffffff;
      --color-bg-secondary: #f8fafc;
      --color-bg-tertiary: #f1f5f9;
      --color-text-primary: #1e293b;
      --color-text-secondary: #64748b;
      --color-text-muted: #94a3b8;
      --color-border: #e5e7eb;
      --color-border-light: #f1f5f9;
      
     /* Sidebar Colors */
     --color-sidebar-bg: #1e293b;
      --color-sidebar-hover: #334155;
      --color-sidebar-active: #0ea5e9;
      
      /* Typography */
      --font-family: 'Poppins', sans-serif;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      --line-height-tight: 1.25;
      --line-height-normal: 1.5;
      --line-height-relaxed: 1.75;
      
      /* Spacing System */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;
      
      /* Border Radius */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      --radius-full: 9999px;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-base: 0.2s ease;
      --transition-slow: 0.3s ease;
    }
    
    body {
      font-family: var(--font-family);
      background-color: var(--color-bg-secondary);
      color: var(--color-text-primary);
      font-size: var(--font-size-base);
      line-height: var(--line-height-normal);
    }

    .sidebar {
      background-color: var(--color-sidebar-bg);
      min-height: 100vh;
      color: #fff;
      padding-top: var(--spacing-xl);
      position: fixed;
      width: 250px;
      z-index: 1000;
    }

    .sidebar a {
      display: block;
      color: var(--color-text-muted);
      text-decoration: none;
      padding: var(--spacing-md) var(--spacing-xl);
      transition: var(--transition-base);
      cursor: pointer;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: var(--color-sidebar-hover);
      color: #fff;
      border-left: 4px solid var(--color-sidebar-active);
    }

    .content {
      margin-left: 260px;
      padding: var(--spacing-2xl);
    }

    .stat-card {
      background: var(--color-bg-primary);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      height: 100%;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, transparent, currentColor, transparent);
      opacity: 0.6;
    }
    
    .stat-card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      transform: translateY(-4px);
    }
    
    .stat-card .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
      opacity: 0.9;
    }
    
    .stat-card h6 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      opacity: 0.7;
    }
    
    .stat-card h2 {
      font-size: 32px;
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
    }

    .border-blue { 
      color: #0ea5e9;
    }
    .border-blue .stat-icon {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }
    
    .border-sky { 
      color: #0ea5e9;
    }
    .border-sky .stat-icon {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }
    
    .border-green { 
      color: #10b981;
    }
    .border-green .stat-icon {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    
    .border-amber { 
      color: #f59e0b;
    }
    .border-amber .stat-icon {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }
    
    .border-red { 
      color: #ef4444;
    }
    .border-red .stat-icon {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* ============================================
       BUTTON STYLES - Standardized
       ============================================ */
    .btn {
      font-family: var(--font-family);
      font-weight: var(--font-weight-medium);
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      border: none;
      cursor: pointer;
      font-size: var(--font-size-sm);
      line-height: var(--line-height-tight);
    }
    
    .btn-primary {
      background-color: var(--color-primary);
      color: #fff;
    }
    
    .btn-primary:hover {
      background-color: var(--color-primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-success {
      background-color: var(--color-success);
      color: #fff;
    }
    
    .btn-success:hover {
      background-color: #059669;
    }

    /* ============================================
       LOADING & EMPTY STATES
       ============================================ */
    .loading {
      text-align: center;
      padding: var(--spacing-3xl);
      color: var(--color-text-secondary);
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
      border-width: 0.25em;
    }
    
    .empty-state {
      text-align: center;
      padding: var(--spacing-3xl);
      color: var(--color-text-secondary);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--color-text-muted);
      margin-bottom: var(--spacing-lg);
    }
    
    .empty-state p {
      font-size: var(--font-size-lg);
      color: var(--color-text-secondary);
      margin-top: var(--spacing-lg);
    }

    /* ============================================
       ALERT/TOAST STYLES
       ============================================ */
    .alert-toast {
      position: fixed;
      top: var(--spacing-xl);
      right: var(--spacing-xl);
      z-index: 9999;
      min-width: 300px;
      max-width: 400px;
    }
    
    .alert {
      border-radius: var(--radius-lg);
      padding: var(--spacing-md) var(--spacing-lg);
      box-shadow: var(--shadow-lg);
      border: none;
    }

    /* ============================================
       CARD STYLES
       ============================================ */
    .equipment-card {
      background: var(--color-bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border-light);
      transition: var(--transition-base);
    }

    .equipment-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .badge-status {
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
    }


    /* Analytics Cards */
    .analytics-card {
      background: var(--color-bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border-light);
      transition: var(--transition-base);
    }

    .analytics-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .analytics-stat {
      text-align: center;
      padding: var(--spacing-lg);
    }

    .analytics-stat-value {
      font-size: 2.5rem;
      font-weight: var(--font-weight-bold);
      color: var(--color-primary);
      margin: var(--spacing-sm) 0;
    }

    .analytics-stat-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Real-time notification badge */
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--color-danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: var(--font-weight-bold);
    }

    .filter-card {
      background: var(--color-bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border-light);
    }

    .request-card {
      background: var(--color-bg-primary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.08);
      border-left: 4px solid #3b82f6;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .request-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: currentColor;
      transition: width 0.3s ease;
    }
    
    .request-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transform: translateX(4px);
      border-left-width: 6px;
    }
    
    .request-card:hover::before {
      width: 6px;
    }

    .request-card.pending { 
      border-left-color: #f59e0b;
      color: #f59e0b;
    }
    .request-card.approved { 
      border-left-color: #10b981;
      color: #10b981;
    }
    .request-card.rejected { 
      border-left-color: #ef4444;
      color: #ef4444;
    }
    
    .request-card h5 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--color-text-primary);
    }
    
    .request-card .badge {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
    }
    
    /* Profile Styles */
    .profile-info-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .profile-info-item {
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    
    .profile-info-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .profile-info-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #64748b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    
    .profile-info-value {
      font-size: 16px;
      font-weight: 500;
      color: var(--color-text-primary);
    }
    
    .profile-stats-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .profile-stat-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .profile-stat-item:hover {
      background: #f1f5f9;
      transform: translateX(4px);
    }
    
    .profile-stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .profile-stat-content {
      flex: 1;
    }
    
    .profile-stat-label {
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      margin-bottom: 4px;
    }
    
    .profile-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--color-text-primary);
    }

    /* ============================================
       SECTION TITLE
       ============================================ */
    .section-title {
      position: sticky;
      top: 0;
      z-index: 500;
      background: var(--color-bg-secondary);
      padding: var(--spacing-md) 0 var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title h2 {
      margin: 0;
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-2xl);
      color: var(--color-text-primary);
    }

    .notification-icon-wrapper {
      position: relative;
    }

    .notification-icon-wrapper .btn {
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
    }

    .notification-icon-wrapper .btn:hover {
      background: var(--color-bg-tertiary);
    }

    /* Notifications Dropdown */
    .notifications-dropdown {
      position: fixed;
      top: 80px;
      right: 20px;
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      width: 320px;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1050;
      display: none;
    }

    .notifications-dropdown.show {
      display: block !important;
    }

    .notifications-header {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--color-bg-secondary);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .notifications-header h6 {
      margin: 0;
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-base);
      color: var(--color-text-primary);
    }

    .notifications-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--color-border-light);
      cursor: pointer;
      transition: var(--transition-base);
    }

    .notification-item:hover {
      background: var(--color-bg-secondary);
    }

    .notification-item.unread {
      background: var(--color-info-light);
      border-left: 3px solid var(--color-info);
    }

    .notification-item .notification-time {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-top: var(--spacing-xs);
    }

    .notification-item p {
      margin: 0;
      font-size: var(--font-size-sm);
      color: var(--color-text-primary);
      line-height: 1.4;
    }

    .notification-item.unread p {
      font-weight: var(--font-weight-medium);
    }

    @media (max-width: 768px) {
      .notifications-dropdown {
        right: 10px;
        left: 10px;
        width: auto;
        max-width: calc(100% - 20px);
      }
    }

    /* Mobile header and responsive sidebar */
    /* ============================================
       MOBILE HEADER
       ============================================ */
    .mobile-header {
      display: none;
      position: sticky;
      top: 0;
      z-index: 1100;
      background: var(--color-bg-primary);
      border-bottom: 1px solid var(--color-border);
      padding: var(--spacing-md) var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .mobile-header .btn-menu {
      background: var(--color-sidebar-bg);
      color: #fff;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
    }
    
    .mobile-header .btn-menu:hover {
      background: var(--color-sidebar-hover);
    }
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 900;
    }

    @media (max-width: 991.98px) {
      .mobile-header { display: block; }
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.25s ease;
      }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.show { display: block; }
      .content { margin-left: 0; padding: 20px; }
      .stat-card { margin-bottom: 12px; }
    }
  </style>
</head>

<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <button id="mobileMenuBtn" class="btn-menu"><i class="bi bi-list"></i></button>
    <span class="ms-2 fw-semibold">CCIS E-Bulod — Borrower</span>
  </div>
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <!-- Alert Toast Container -->
  <div id="alertContainer" class="alert-toast"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="text-center mb-4">
      <img src="images/logo.png" alt="Logo" width="60" class="mx-auto mb-2 d-block">
      <h5 class="fw-bold mb-0">CCIS E-Bulod</h5>
      <small class="text-secondary">Borrower Portal</small>
    </div>
    <a href="#" class="nav-link active" data-section="dashboard">
      <i class="bi bi-speedometer2 me-2"></i>Dashboard
    </a>
    <a href="#" class="nav-link" data-section="browse">
      <i class="bi bi-box-seam me-2"></i>Browse Equipment
    </a>
    <a href="#" class="nav-link" data-section="requests">
      <i class="bi bi-file-earmark-text me-2"></i>My Requests
    </a>
    <a href="#" class="nav-link" data-section="analytics">
      <i class="bi bi-graph-up-arrow me-2"></i>Analytics
    </a>
    <a href="#" class="nav-link" data-section="profile">
      <i class="bi bi-person me-2"></i>My Profile
    </a>
    <a href="#" id="logoutBtn" class="mt-3">
      <i class="bi bi-box-arrow-right me-2"></i>Logout
    </a>
  </div>

  <!-- Main Content -->
  <div class="content">
    <div class="section-title">
      <h2 id="sectionTitleText">Dashboard Overview</h2>
      <div class="notification-icon-wrapper">
        <button class="btn btn-link position-relative" id="notificationIcon" style="color: var(--color-text-primary); text-decoration: none; padding: 8px;">
          <i class="bi bi-bell" style="font-size: 1.5rem;"></i>
          <span class="badge bg-danger position-absolute top-0 start-100 translate-middle" id="notificationBadge" style="display: none; font-size: 0.7rem; min-width: 18px; height: 18px; padding: 2px 5px;">0</span>
        </button>
      </div>
    </div>
    <!-- Dashboard Section -->
    <div id="dashboardSection" class="section active">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold d-none">Dashboard Overview</h2>
        <span id="borrowerName" class="text-muted">Welcome, Borrower</span>
      </div>

      <!-- Dashboard Cards -->
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="stat-card border-blue">
            <div class="stat-icon">
              <i class="bi bi-file-earmark-text"></i>
            </div>
            <h6>My Requests</h6>
            <h2 id="myRequests">0</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card border-amber">
            <div class="stat-icon">
              <i class="bi bi-clock-history"></i>
            </div>
            <h6>Pending</h6>
            <h2 id="pendingCount">0</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card border-green">
            <div class="stat-icon">
              <i class="bi bi-check-circle"></i>
            </div>
            <h6>Approved</h6>
            <h2 id="approvedCount">0</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card border-sky">
            <div class="stat-icon">
              <i class="bi bi-box-seam"></i>
            </div>
            <h6>Available Equipment</h6>
            <h2 id="availableCount">0</h2>
          </div>
        </div>
      </div>

      <!-- Trust Points Card -->
      <div class="row g-4 mb-4">
        <div class="col-md-12">
          <div class="stat-card" style="border-left: 4px solid #8b5cf6; background: linear-gradient(135deg, #f3e8ff 0%, #ffffff 100%);">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-3">
                <div class="stat-icon" style="background: #8b5cf6; color: white;">
                  <i class="bi bi-shield-check"></i>
                </div>
                <div>
                  <h6 class="mb-1" style="color: #6b21a8; font-weight: 600;">Trust Points</h6>
                  <h2 id="trustPoints" style="color: #7c3aed; margin: 0;">0</h2>
                  <small id="trustPointsStatus" style="color: #64748b; font-size: 0.875rem;"></small>
                </div>
              </div>
              <div id="trustPointsWarning" style="display: none;">
                <div class="alert alert-warning mb-0" style="padding: 12px 16px; border-radius: 8px;">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>Cannot Borrow:</strong> Your trust points are below 2. Please visit the Dean's office for an appeal.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Requests -->
      <div class="bg-white p-4 rounded-3 shadow-sm border-0" style="border-top: 3px solid #3b82f6 !important;">
        <div class="d-flex align-items-center mb-4">
          <div class="me-3" style="width: 4px; height: 32px; background: linear-gradient(180deg, #3b82f6, #2563eb); border-radius: 2px;"></div>
          <h5 class="fw-bold mb-0" style="font-size: 18px;">Recent Requests</h5>
        </div>
        <div id="recentRequests" class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Browse Equipment Section -->
    <div id="browseSection" class="section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold d-none">Browse Available Equipment</h2>
      </div>

      <!-- Scan Barcode Button -->
      <div class="mb-3">
        <button id="openBarcodeScannerBtn" class="btn btn-primary btn-lg w-100">
          <i class="bi bi-upc-scan me-2"></i>Scan A Barcode
        </button>
      </div>

      <!-- Filters -->
      <div class="filter-card">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Search</label>
            <input type="text" id="searchEquipment" class="form-control" placeholder="Search by name, category, location...">
          </div>
          <div class="col-md-3">
            <label class="form-label">Category</label>
            <input type="text" id="filterCategory" class="form-control" placeholder="Category...">
          </div>
          <div class="col-md-3">
            <label class="form-label">Location</label>
            <input type="text" id="filterLocation" class="form-control" placeholder="Location...">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button id="clearFilters" class="btn btn-outline-secondary w-100">
              <i class="bi bi-x-circle"></i> Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Equipment Grid -->
      <div id="equipmentGrid">
        <div class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- My Requests Section -->
    <div id="requestsSection" class="section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold d-none">My Borrowing Requests</h2>
      </div>

      <div id="requestsList">
        <div class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Section -->
    <div id="analyticsSection" class="section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold d-none">My Analytics</h2>
      </div>

      <div id="analyticsContent">
        <div class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Section -->
    <div id="profileSection" class="section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold d-none">My Profile</h2>
      </div>

      <div class="bg-white p-4 rounded shadow-sm">
        <div id="profileContent">
          <div class="loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Request Equipment Modal -->
  <div class="modal fade" id="requestModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="requestForm">
          <div class="modal-header">
            <h5 class="modal-title">Request Equipment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="requestEquipmentId">
            <input type="hidden" id="requestEquipmentName">

            <div class="mb-3">
              <label class="form-label">Equipment</label>
              <input type="text" class="form-control" id="requestEquipmentDisplay" readonly>
            </div>

            <div class="mb-3">
              <label class="form-label">Purpose <span class="text-danger">*</span></label>
              <textarea class="form-control" id="requestPurpose" rows="3" placeholder="What do you need this equipment for?" required></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Request Date <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="requestDate" required>
              <small class="text-muted">Date when you need the equipment</small>
            </div>

            <div class="mb-3">
              <label class="form-label">Time Range <span class="text-danger">*</span></label>
              <small class="text-muted d-block mb-2">Specify the time you need the equipment on the request date (e.g., for a class)</small>
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label small">Start Time <span class="text-danger">*</span></label>
                  <select class="form-select" id="requestStartTime" required>
                    <option value="">Select start time</option>
                    <option value="07:30">7:30 AM</option>
                    <option value="08:00">8:00 AM</option>
                    <option value="08:30">8:30 AM</option>
                    <option value="09:00">9:00 AM</option>
                    <option value="09:30">9:30 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="10:30">10:30 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <option value="11:30">11:30 AM</option>
                    <option value="12:00">12:00 PM</option>
                    <option value="12:30">12:30 PM</option>
                    <option value="13:00">1:00 PM</option>
                    <option value="13:30">1:30 PM</option>
                    <option value="14:00">2:00 PM</option>
                    <option value="14:30">2:30 PM</option>
                    <option value="15:00">3:00 PM</option>
                    <option value="15:30">3:30 PM</option>
                    <option value="16:00">4:00 PM</option>
                    <option value="16:30">4:30 PM</option>
                    <option value="17:00">5:00 PM</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label small">End Time <span class="text-danger">*</span></label>
                  <select class="form-select" id="requestEndTime" required>
                    <option value="">Select end time</option>
                    <option value="07:30">7:30 AM</option>
                    <option value="08:00">8:00 AM</option>
                    <option value="08:30">8:30 AM</option>
                    <option value="09:00">9:00 AM</option>
                    <option value="09:30">9:30 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="10:30">10:30 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <option value="11:30">11:30 AM</option>
                    <option value="12:00">12:00 PM</option>
                    <option value="12:30">12:30 PM</option>
                    <option value="13:00">1:00 PM</option>
                    <option value="13:30">1:30 PM</option>
                    <option value="14:00">2:00 PM</option>
                    <option value="14:30">2:30 PM</option>
                    <option value="15:00">3:00 PM</option>
                    <option value="15:30">3:30 PM</option>
                    <option value="16:00">4:00 PM</option>
                    <option value="16:30">4:30 PM</option>
                    <option value="17:00">5:00 PM</option>
                  </select>
                </div>
              </div>
              <small class="text-muted">Example: 9:00 AM - 10:00 AM for a class</small>
            </div>

            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Your request will be reviewed by an administrator.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit Request</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Barcode Scanner Modal -->
  <div class="modal fade" id="barcodeScannerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-upc-scan me-2"></i>Scan Barcode
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-4">
            <i class="bi bi-upc-scan" style="font-size: 4rem; color: #667eea;"></i>
            <h6 class="mt-3">Scan your barcode</h6>
            <p class="text-muted">Point your barcode scanner at the input field below and scan an equipment barcode</p>
          </div>
          <div class="mb-3">
            <label class="form-label">Barcode</label>
            <input 
              type="text" 
              id="barcodeScannerInput" 
              class="form-control form-control-lg text-center" 
              placeholder="Scan barcode or enter barcode manually..." 
              autocomplete="off"
              style="font-size: 1.2rem; letter-spacing: 2px;"
            >
            <small class="text-muted d-block mt-2 text-center">
              <i class="bi bi-info-circle"></i> The request form will open automatically when a valid barcode is scanned
            </small>
          </div>
          <div class="d-flex gap-2">
            <button id="clearBarcodeBtn" class="btn btn-outline-secondary w-100" style="display: none;">
              <i class="bi bi-x-circle"></i> Clear
            </button>
            <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Request Modal -->
  <div class="modal fade" id="cancelRequestModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="cancelRequestForm">
          <div class="modal-header">
            <h5 class="modal-title">Cancel Request</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="cancelRequestId">
            <input type="hidden" id="cancelEquipmentId">
            <input type="hidden" id="cancelEquipmentName">

            <div class="mb-3">
              <label class="form-label">Equipment</label>
              <input type="text" class="form-control" id="cancelEquipmentDisplay" readonly>
            </div>

            <div class="mb-3">
              <label class="form-label">Cancellation Reason <span class="text-danger">*</span></label>
              <textarea class="form-control" id="cancelReason" rows="4" placeholder="Please explain why you are cancelling this request..." required></textarea>
              <small class="text-muted">This information will be visible to administrators.</small>
            </div>

            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i> Are you sure you want to cancel this request? This action cannot be undone.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Request</button>
            <button type="submit" class="btn btn-danger">Cancel Request</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Equipment Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="reviewForm">
          <div class="modal-header">
            <h5 class="modal-title">Equipment Feedback</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="reviewRequestId">
            <input type="hidden" id="reviewEquipmentId">
            <input type="hidden" id="reviewEquipmentName">

            <div class="mb-3">
              <label class="form-label">Equipment</label>
              <input type="text" class="form-control" id="reviewEquipmentDisplay" readonly>
            </div>

            <div class="mb-3">
              <label class="form-label">Feedback <span class="text-danger">*</span></label>
              <textarea class="form-control" id="reviewComment" rows="4" placeholder="Share your experience with this equipment..." required></textarea>
              <small class="text-muted">Please provide your feedback about this equipment.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit Feedback</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notifications Dropdown -->
  <div class="notifications-dropdown" id="notificationsDropdown">
    <div class="notifications-header">
      <h6>Notifications</h6>
      <button class="btn btn-sm btn-link p-0" id="markAllReadBtn" style="font-size: 0.75rem; text-decoration: none;">Mark all as read</button>
    </div>
    <div class="notifications-list" id="notificationsList">
      <div class="notification-item">
        <p class="text-muted text-center mb-0">Loading notifications...</p>
      </div>
    </div>
  </div>

  <!-- API Client -->
  <script src="js/api.js?v=2.7"></script>
  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Global Variables
    let borrowerId = null;
    let allEquipment = [];
    let notifications = [];
    let notificationPollInterval = null;
    let lastNotificationCheck = null;
    
    // Performance: Cache for API responses
    const apiCache = {
      equipment: { data: null, timestamp: 0, ttl: 30000 }, // 30 seconds
      requests: { data: null, timestamp: 0, ttl: 10000 }, // 10 seconds
      stats: { data: null, timestamp: 0, ttl: 5000 } // 5 seconds
    };
    
    // Get cached data or fetch new
    async function getCachedData(cacheKey, fetchFn, ttl = 10000) {
      const cache = apiCache[cacheKey];
      const now = Date.now();
      
      if (cache && cache.data && (now - cache.timestamp) < ttl) {
        return cache.data;
      }
      
      const data = await fetchFn();
      apiCache[cacheKey] = { data, timestamp: now, ttl };
      return data;
    }
    
    // Clear cache
    function clearCache(cacheKey = null) {
      if (cacheKey) {
        apiCache[cacheKey] = { data: null, timestamp: 0, ttl: 0 };
      } else {
        Object.keys(apiCache).forEach(key => {
          apiCache[key] = { data: null, timestamp: 0, ttl: 0 };
        });
      }
    }
    
    // Debounce function for search/filter inputs
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Session check
    borrowerId = localStorage.getItem("borrowerId");
    if (!borrowerId) {
      window.location.href = "index.html";
    } else {
      document.getElementById("borrowerName").textContent = `Welcome, ${borrowerId}`;
    }

    // Mobile sidebar toggle
    const sidebarEl = document.getElementById('sidebar');
    const overlayEl = document.getElementById('sidebarOverlay');
    const mobileBtn = document.getElementById('mobileMenuBtn');

    function openSidebar() {
      if (sidebarEl) sidebarEl.classList.add('open');
      if (overlayEl) overlayEl.classList.add('show');
    }
    function closeSidebar() {
      if (sidebarEl) sidebarEl.classList.remove('open');
      if (overlayEl) overlayEl.classList.remove('show');
    }
    if (mobileBtn) mobileBtn.addEventListener('click', openSidebar);
    if (overlayEl) overlayEl.addEventListener('click', closeSidebar);
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 992) closeSidebar();
      });
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await AuthAPI.logout();
        localStorage.removeItem("borrowerId");
        localStorage.removeItem("userRole");
        showAlert("Logged out successfully!", "success");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1000);
      } catch (error) {
        console.error("Logout error:", error);
        localStorage.removeItem("borrowerId");
        localStorage.removeItem("userRole");
        window.location.href = "index.html";
      }
    });

    // Navigation System
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = link.getAttribute('data-section');
        if (section) {
          switchSection(section);
        }
      });
    });

    function switchSection(sectionName) {
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));

      document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
      document.getElementById(`${sectionName}Section`).classList.add('active');

      // Update sticky title and persist state
      const titleMap = {
        dashboard: 'Dashboard Overview',
        browse: 'Browse Equipment',
        requests: 'My Borrowing Requests',
        analytics: 'My Analytics',
        profile: 'My Profile'
      };
      const title = titleMap[sectionName] || 'Dashboard';
      const titleEl = document.getElementById('sectionTitleText');
      if (titleEl) titleEl.textContent = title;
      try { localStorage.setItem('borrowerActiveSection', sectionName); } catch (e) {}

      if (sectionName === 'dashboard') {
        loadDashboardStats();
        loadRecentRequests();
      } else if (sectionName === 'browse') {
        loadAvailableEquipment();
        // No auto-focus for barcode scanner (it's now in a modal)
      } else if (sectionName === 'requests') {
        loadMyRequests();
      } else if (sectionName === 'analytics') {
        loadAnalytics();
      } else if (sectionName === 'profile') {
        loadProfile();
      }
    }

    // Alert System
    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // Load Dashboard Stats (optimized with caching and parallel calls)
    async function loadDashboardStats() {
      try {
        // Load requests, equipment, and borrower data in parallel with caching
        // Use shorter cache TTL for borrower data (5 seconds) to ensure trust points are up-to-date
        const [requests, equipment, borrowerData] = await Promise.all([
          getCachedData('requests', () => RequestsAPI.getAll({ borrowerId: borrowerId }), 10000),
          getCachedData('equipment', () => EquipmentAPI.getAll(), 30000),
          getCachedData('borrower', () => BorrowersAPI.getById(borrowerId), 5000) // Reduced TTL to 5 seconds for fresh trust points
        ]);
        
        let pending = 0;
        let approved = 0;
        let total = 0;

        requests.forEach(req => {
          const status = (req.status || '').toLowerCase();
          total++;
          if (status.includes('pending')) pending++;
          if (status.includes('approved') || status.includes('active')) approved++;
          // Note: Cancelled requests are not counted in pending or approved
        });

        document.getElementById("myRequests").textContent = total;
        document.getElementById("pendingCount").textContent = pending;
        document.getElementById("approvedCount").textContent = approved;

        const available = equipment.filter(e => e.status === 'Available').length;
        document.getElementById("availableCount").textContent = available;

        // Display trust points
        const trustPoints = borrowerData?.trustPoints || borrowerData?.trust_points || 20;
        document.getElementById("trustPoints").textContent = trustPoints;
        
        // Show warning if trust points are below 2 (1 point is ineligible)
        const trustPointsWarning = document.getElementById("trustPointsWarning");
        const trustPointsStatus = document.getElementById("trustPointsStatus");
        if (trustPoints < 2) {
          trustPointsWarning.style.display = 'block';
          trustPointsStatus.textContent = "⚠️ Ineligible to borrow equipment";
          trustPointsStatus.style.color = "#ef4444";
        } else {
          trustPointsWarning.style.display = 'none';
          trustPointsStatus.textContent = "✓ Eligible to borrow equipment";
          trustPointsStatus.style.color = "#10b981";
        }
      } catch (error) {
        console.error("Error loading stats:", error);
        showAlert("Error loading dashboard statistics", "danger");
      }
    }

    // Load Recent Requests (optimized with caching)
    async function loadRecentRequests() {
      const recentDiv = document.getElementById("recentRequests");
      try {
        const requests = await getCachedData('requests', () => RequestsAPI.getAll({ borrowerId: borrowerId }), 10000);
        
        // Sort by timestamp (newest first) and get top 5
        requests.sort((a, b) => {
          const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
          const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
          return timeB - timeA;
        });
        
        const recent = requests.slice(0, 5);

        if (recent.length === 0) {
          recentDiv.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>No recent requests</p></div>';
          return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
        recent.forEach(req => {
          const date = req.timestamp ? new Date(req.timestamp).toLocaleDateString() : 'N/A';
          const statusBadge = getStatusBadge(req.status);
          const status = (req.status || 'pending').toLowerCase();
          const statusColor = status.includes('approved') ? '#10b981' : 
                             status.includes('pending') ? '#f59e0b' : 
                             status.includes('rejected') ? '#ef4444' : '#64748b';
          html += `
            <div style="background: white; border-radius: 12px; padding: 16px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.2s ease;"
                 onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateX(4px)';"
                 onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.06)'; this.style.transform='translateX(0)';">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></div>
                    <strong style="font-size: 16px; font-weight: 600; color: #1e293b;">${escapeHtml(req.equipmentName || 'Unknown Equipment')}</strong>
                  </div>
                  <p style="font-size: 14px; color: #64748b; margin-bottom: 12px; line-height: 1.5;">${escapeHtml(req.purpose || 'No purpose specified')}</p>
                  <div class="d-flex align-items-center gap-2">
                    ${statusBadge}
                    <span style="font-size: 12px; color: #94a3b8;">•</span>
                    <span style="font-size: 12px; color: #64748b;">${date}</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        recentDiv.innerHTML = html;
      } catch (error) {
        console.error("Error loading requests:", error);
        recentDiv.innerHTML = "<p class='text-danger'>Error loading recent requests</p>";
      }
    }

    // Load Available Equipment (optimized with caching)
    // Shows: Available (with request button) and Under Repair (with unavailable button)
    // Hides: Borrowed equipment
    async function loadAvailableEquipment() {
      const gridDiv = document.getElementById("equipmentGrid");
      gridDiv.innerHTML = '<div class="loading"><div class="spinner-border text-primary" role="status"></div></div>';

      try {
        // Load equipment with caching
        const equipment = await getCachedData('equipment', () => EquipmentAPI.getAll(), 30000);
        
        // Only include Available and Under Repair equipment (exclude Borrowed)
        allEquipment = equipment.filter(e => 
          e.status === 'Available' || e.status === 'Under Repair'
        );

        displayEquipment();
      } catch (error) {
        console.error("Error loading equipment:", error);
        showAlert("Error loading equipment", "danger");
        gridDiv.innerHTML = "<p class='text-danger'>Error loading equipment</p>";
      }
    }

    function displayEquipment() {
      const gridDiv = document.getElementById("equipmentGrid");
      const search = document.getElementById("searchEquipment").value.toLowerCase();
      const category = document.getElementById("filterCategory").value.toLowerCase();
      const location = document.getElementById("filterLocation").value.toLowerCase();

      // Filter equipment (only Available and Under Repair are in allEquipment)
      const filtered = allEquipment.filter(item => {
        // Enhanced search - search in name, category, and location
        const matchesSearch = !search || 
          item.name?.toLowerCase().includes(search) ||
          item.category?.toLowerCase().includes(search) ||
          item.location?.toLowerCase().includes(search);
        const matchesCategory = !category || item.category?.toLowerCase().includes(category);
        const matchesLocation = !location || item.location?.toLowerCase().includes(location);
        return matchesSearch && matchesCategory && matchesLocation;
      });

      if (filtered.length === 0) {
        gridDiv.innerHTML = '<div class="empty-state"><i class="bi bi-box-seam"></i><p>No equipment found</p></div>';
        return;
      }

      let html = '<div class="row g-4">';
      filtered.forEach(item => {
        const isAvailable = item.status === 'Available';
        const isUnderRepair = item.status === 'Under Repair';
        
        // Status badge
        let statusBadge = '';
        if (isAvailable) {
          statusBadge = '<span class="badge bg-success mb-2">Available</span>';
        } else if (isUnderRepair) {
          statusBadge = '<span class="badge bg-warning mb-2">Under Repair</span>';
        }

        html += `
          <div class="col-md-4">
            <div class="equipment-card">
              ${item.imageUrl ? `
                <img src="${escapeHtml(item.imageUrl)}" alt="${escapeHtml(item.name)}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;">
              ` : `
                <div style="width: 100%; height: 200px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                  <i class="bi bi-image" style="font-size: 3rem;"></i>
                </div>
              `}
              <h5>${escapeHtml(item.name)}</h5>
              <p class="text-muted mb-2">
                ${statusBadge}<br>
                <i class="bi bi-tag"></i> ${escapeHtml(item.category || 'N/A')}<br>
                <i class="bi bi-geo-alt"></i> ${escapeHtml(item.location || 'N/A')}<br>
                <span class="badge ${item.condition === 'Good' ? 'bg-success' : 'bg-danger'}">${item.condition || 'N/A'}</span>
              </p>
              ${isAvailable ? `
                <button class="btn btn-primary w-100" onclick="openRequestModal('${item.id}', '${escapeHtml(item.name)}')">
                  <i class="bi bi-cart-plus"></i> Request Equipment
                </button>
              ` : `
                <button class="btn btn-secondary w-100" disabled>
                  <i class="bi bi-x-circle"></i> Unavailable
                </button>
              `}
            </div>
          </div>
        `;
      });
      html += '</div>';
      gridDiv.innerHTML = html;
    }

    // Filter Event Listeners (with debouncing for better performance)
    const debouncedDisplayEquipment = debounce(displayEquipment, 300);
    document.getElementById("searchEquipment").addEventListener("input", debouncedDisplayEquipment);
    document.getElementById("filterCategory").addEventListener("input", debouncedDisplayEquipment);
    document.getElementById("filterLocation").addEventListener("input", debouncedDisplayEquipment);
    document.getElementById("clearFilters").addEventListener("click", () => {
      document.getElementById("searchEquipment").value = '';
      document.getElementById("filterCategory").value = '';
      document.getElementById("filterLocation").value = '';
      displayEquipment();
    });

    // Helper function to reset barcode input after modal closes
    function resetBarcodeInputAfterModal(modalElement) {
      const barcodeInput = document.getElementById("barcodeScannerInput");
      if (!barcodeInput) return;
      
      const handleModalHidden = () => {
        // Remove any modal backdrop that might be stuck
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
          backdrop.remove();
        }
        // Remove modal-open class from body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Re-enable barcode input and reset focus
        barcodeInput.disabled = false;
        barcodeInput.style.borderColor = '';
        barcodeInput.value = '';
        
        // Only focus if we're still on the browse section
        const browseSection = document.getElementById("browseSection");
        if (browseSection && browseSection.classList.contains("active")) {
          setTimeout(() => {
            barcodeInput.focus();
          }, 100);
        }
        
        // Remove the event listener to prevent memory leaks
        modalElement.removeEventListener('hidden.bs.modal', handleModalHidden);
      };
      
      // Use once option to automatically remove listener
      modalElement.addEventListener('hidden.bs.modal', handleModalHidden, { once: true });
    }

    // Open Request Modal
    async function openRequestModal(equipmentId, equipmentName) {
      // Check trust points before allowing request
      try {
        const apiBase = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 'api/' : '/api/';
        const borrowerData = await fetch(`${apiBase}borrowers?id=${borrowerId}`).then(r => r.json()).then(d => d.data);
        const trustPoints = borrowerData?.trustPoints || borrowerData?.trust_points || 20;
        
        if (trustPoints < 2) {
          showAlert("You cannot borrow equipment because your trust points are below 2. Please visit the Dean's office for an appeal.", "danger");
          return;
        }
      } catch (error) {
        console.error("Error checking trust points:", error);
        // Continue with modal opening even if check fails
      }
      
      document.getElementById("requestEquipmentId").value = equipmentId;
      document.getElementById("requestEquipmentName").value = equipmentName;
      document.getElementById("requestEquipmentDisplay").value = equipmentName;
      
      // Set minimum date to today (prevents selecting past dates)
      const requestDateInput = document.getElementById("requestDate");
      if (requestDateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;
        requestDateInput.setAttribute('min', todayStr);
        requestDateInput.value = ''; // Clear any previous selection
      }
      
      // Clear and reset the barcode scanner input
      const barcodeInput = document.getElementById("barcodeScannerInput");
      if (barcodeInput) {
        barcodeInput.value = '';
        barcodeInput.disabled = false;
        barcodeInput.style.borderColor = '';
      }
      
      const modalElement = document.getElementById("requestModal");
      const modal = new bootstrap.Modal(modalElement);
      
      // Set up cleanup when modal closes (either by cancel or submit)
      resetBarcodeInputAfterModal(modalElement);
      
      modal.show();
    }

    // ============================================
    // BARCODE SCANNER FUNCTIONALITY
    // ============================================
    
    let barcodeInputBuffer = '';
    let barcodeInputTimer = null;
    const BARCODE_INPUT_DELAY = 800; // milliseconds - delay to distinguish manual typing from scanner input

    // Open barcode scanner modal
    function openBarcodeScannerModal() {
      const modalElement = document.getElementById("barcodeScannerModal");
      const modal = new bootstrap.Modal(modalElement);
      
      // Reset input when modal is shown
      modalElement.addEventListener('shown.bs.modal', () => {
        const barcodeInput = document.getElementById("barcodeScannerInput");
        if (barcodeInput) {
          barcodeInput.value = '';
          barcodeInput.focus();
        }
      }, { once: true });
      
      modal.show();
    }

    // Initialize barcode scanner
    function initializeBarcodeScanner() {
      const barcodeInput = document.getElementById("barcodeScannerInput");
      const clearBarcodeBtn = document.getElementById("clearBarcodeBtn");
      const openBarcodeBtn = document.getElementById("openBarcodeScannerBtn");
      
      // Open barcode scanner modal when button is clicked
      if (openBarcodeBtn) {
        openBarcodeBtn.addEventListener("click", () => {
          openBarcodeScannerModal();
        });
      }
      
      if (!barcodeInput) return;

      // Handle barcode input
      barcodeInput.addEventListener("input", (e) => {
        const value = e.target.value.trim();
        
        // Show clear button if there's input
        if (clearBarcodeBtn) {
          clearBarcodeBtn.style.display = value ? 'block' : 'none';
        }

        // Clear previous timer
        if (barcodeInputTimer) {
          clearTimeout(barcodeInputTimer);
        }

        // Only set timer if there's actual content
        // This prevents triggering on every keystroke during manual typing
        if (value.length > 0) {
          // Set timer to detect end of barcode input
          // Barcode scanners input very quickly, so if there's a delay, it's likely the end
          // Manual typing will reset the timer on each keystroke, so it won't trigger
          barcodeInputTimer = setTimeout(() => {
            const currentValue = barcodeInput.value.trim();
            if (currentValue.length > 0) {
              handleBarcodeScan(currentValue);
            }
          }, BARCODE_INPUT_DELAY);
        }
      });

      // Handle Enter key (for both barcode scanners and manual input)
      barcodeInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          
          // Clear any pending timer
          if (barcodeInputTimer) {
            clearTimeout(barcodeInputTimer);
            barcodeInputTimer = null;
          }
          
          const value = barcodeInput.value.trim();
          if (value.length > 0) {
            handleBarcodeScan(value);
          }
        }
      });

      // Clear barcode button
      if (clearBarcodeBtn) {
        clearBarcodeBtn.addEventListener("click", () => {
          barcodeInput.value = '';
          barcodeInput.focus();
          clearBarcodeBtn.style.display = 'none';
        });
      }
    }

    // Handle barcode scan
    async function handleBarcodeScan(barcode) {
      const barcodeInput = document.getElementById("barcodeScannerInput");
      
      try {
        // Show loading state
        if (barcodeInput) {
          barcodeInput.style.borderColor = '#0ea5e9';
        }

        // Look up equipment by barcode
        const equipment = await EquipmentAPI.getAll();
        const equipmentData = equipment.find(eq => eq.barcode === barcode);

        if (!equipmentData) {
          showAlert("Equipment not found. Please check the barcode and try again.", "warning");
          if (barcodeInput) {
            barcodeInput.style.borderColor = '#ef4444';
            barcodeInput.value = '';
            setTimeout(() => {
              barcodeInput.style.borderColor = '';
              barcodeInput.focus();
            }, 2000);
          }
          return;
        }

        const equipmentId = equipmentData.id;

        // Check if equipment is available
        if (equipmentData.status !== 'Available') {
          let statusMessage = '';
          if (equipmentData.status === 'Borrowed') {
            statusMessage = 'This equipment is currently borrowed and not available.';
          } else if (equipmentData.status === 'Under Repair') {
            statusMessage = 'This equipment is under repair and not available.';
          } else {
            statusMessage = `This equipment is ${equipmentData.status} and not available.`;
          }
          showAlert(statusMessage, "warning");
          if (barcodeInput) {
            barcodeInput.style.borderColor = '#f59e0b';
            barcodeInput.value = '';
            setTimeout(() => {
              barcodeInput.style.borderColor = '';
              barcodeInput.focus();
            }, 2000);
          }
          return;
        }

        // Equipment found and available - close barcode scanner modal and open request modal
        showAlert(`Equipment found: ${equipmentData.name}`, "success");
        
        // Reset input immediately (don't wait for timeout)
        if (barcodeInput) {
          barcodeInput.style.borderColor = '#10b981';
          barcodeInput.value = '';
          setTimeout(() => {
            barcodeInput.style.borderColor = '';
          }, 500);
        }
        
        // Close barcode scanner modal
        const barcodeModalElement = document.getElementById("barcodeScannerModal");
        const barcodeModal = bootstrap.Modal.getInstance(barcodeModalElement);
        if (barcodeModal) {
          barcodeModal.hide();
        }
        
        // Open request modal after a brief delay to ensure barcode modal is closed
        setTimeout(() => {
          openRequestModal(equipmentId, equipmentData.name);
        }, 300);

      } catch (error) {
        console.error("Error looking up barcode:", error);
        showAlert("Error looking up equipment. Please try again.", "danger");
        if (barcodeInput) {
          barcodeInput.style.borderColor = '';
          barcodeInput.value = '';
          barcodeInput.focus();
        }
      }
    }

    // Request Form
    document.getElementById("requestForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const equipmentIdEl = document.getElementById("requestEquipmentId");
      const equipmentNameEl = document.getElementById("requestEquipmentName");
      const purposeEl = document.getElementById("requestPurpose");
      const requestDateEl = document.getElementById("requestDate");
      const returnDateEl = document.getElementById("requestReturnDate");
      const startTimeEl = document.getElementById("requestStartTime");
      const endTimeEl = document.getElementById("requestEndTime");

      if (!borrowerId) {
        showAlert("Please log in again", "danger");
        window.location.href = "index.html";
        return;
      }

      if (!equipmentIdEl || !equipmentNameEl || !purposeEl || !requestDateEl || !startTimeEl || !endTimeEl) {
        console.error("Missing form elements:", {
          equipmentId: !!equipmentIdEl,
          equipmentName: !!equipmentNameEl,
          purpose: !!purposeEl,
          requestDate: !!requestDateEl,
          startTime: !!startTimeEl,
          endTime: !!endTimeEl
        });
        showAlert("Form fields not found. Please refresh the page and try again.", "danger");
        return;
      }

      const equipmentId = equipmentIdEl.value;
      const equipmentName = equipmentNameEl.value;
      const purpose = purposeEl.value;
      const requestDate = requestDateEl.value;
      const returnDate = returnDateEl?.value || '';
      const startTime = startTimeEl.value;
      const endTime = endTimeEl.value;

      // Validate required fields
      if (!requestDate) {
        showAlert("Please select a request date", "warning");
        return;
      }
      
      // Validate that request date is not in the past
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const selectedDate = new Date(requestDate);
      selectedDate.setHours(0, 0, 0, 0);
      if (selectedDate < today) {
        showAlert("Request date cannot be in the past. Please select today or a future date.", "warning");
        return;
      }

      // Validate time range (required)
      if (!startTime || !endTime) {
        showAlert("Please select both start and end time", "warning");
        return;
      }
      if (startTime >= endTime) {
        showAlert("End time must be after start time", "warning");
        return;
      }

      try {
        await RequestsAPI.create({
          borrowerId: borrowerId,
          equipmentId: equipmentId,
          equipmentName: equipmentName,
          purpose: purpose,
          requestDate: requestDate || null,
          returnDate: returnDate || null,
          startTime: startTime || null,
          endTime: endTime || null
        });
        
        showAlert("Request submitted successfully! It will be reviewed by an administrator.", "success");
        
        const modalElement = document.getElementById("requestModal");
        const modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();
        
        document.getElementById("requestForm").reset();
        
        // Reset barcode input after modal closes
        resetBarcodeInputAfterModal(modalElement);
        
        // Clear cache and reload in parallel
        clearCache('requests');
        clearCache('stats');
        await Promise.all([
          loadDashboardStats(),
          loadRecentRequests(),
          loadMyRequests()
        ]);
      } catch (error) {
        console.error("Error submitting request:", error);
        showAlert("Error submitting request", "danger");
      }
    });

    // Load My Requests
    async function loadMyRequests() {
      const requestsDiv = document.getElementById("requestsList");
      requestsDiv.innerHTML = '<div class="loading"><div class="spinner-border text-primary" role="status"></div></div>';

      try {
        const requests = await getCachedData('requests', () => RequestsAPI.getAll({ borrowerId: borrowerId }), 10000);
        
        // Sort by timestamp (newest first)
        requests.sort((a, b) => {
          const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
          const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
          return timeB - timeA;
        });

        if (requests.length === 0) {
          requestsDiv.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>No requests found</p></div>';
          return;
        }

        let html = '';
        requests.forEach(req => {
          const date = req.timestamp ? new Date(req.timestamp).toLocaleDateString() : 'N/A';
          const status = (req.status || 'pending').toLowerCase();
          const statusClass = status.includes('approved') || status.includes('active') ? 'approved' : 
                             status.includes('rejected') || status.includes('denied') || status.includes('cancelled') ? 'rejected' : 'pending';
          
          // Show cancel button only for pending requests
          const canCancel = status.includes('pending');
          const cancelButton = canCancel ? `
            <button class="btn btn-sm btn-danger mt-2 cancel-request-btn" 
                    data-request-id="${req.id}" 
                    data-equipment-id="${escapeHtml(req.equipmentId || '')}" 
                    data-equipment-name="${escapeHtml(req.equipmentName || 'Unknown Equipment')}">
              <i class="bi bi-x-circle"></i> Cancel Request
            </button>
          ` : '';
          
          // Show review button for returned equipment that hasn't been reviewed
          const canReview = status.includes('returned') && !req.reviewed;
          const reviewButton = canReview ? `
            <button class="btn btn-sm btn-primary mt-2 review-request-btn" 
                    data-request-id="${req.id}" 
                    data-equipment-id="${escapeHtml(req.equipmentId || '')}" 
                    data-equipment-name="${escapeHtml(req.equipmentName || 'Unknown Equipment')}">
              <i class="bi bi-chat-left-text"></i> Leave Feedback
            </button>
          ` : '';
          
          // Show review info if already reviewed
          const reviewInfo = req.reviewed && req.review ? `
            <div class="alert alert-success mt-2 mb-0">
              <small><strong>Your Feedback:</strong> ${req.review.comment ? escapeHtml(req.review.comment) : 'No feedback provided'}</small>
            </div>
          ` : '';
          
          // Show cancellation comment if request was cancelled by borrower
          const cancellationInfo = status.includes('cancelled') && req.cancellationComment ? `
            <div class="alert alert-info mt-2 mb-0">
              <small><strong>Cancellation Reason:</strong> ${escapeHtml(req.cancellationComment)}</small>
            </div>
          ` : '';
          
          html += `
            <div class="request-card ${statusClass}">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: currentColor; opacity: 0.8;"></div>
                    <h5 class="mb-0">${escapeHtml(req.equipmentName || 'Unknown Equipment')}</h5>
                  </div>
                  <p class="text-muted mb-3" style="font-size: 14px; line-height: 1.5;">${escapeHtml(req.purpose || 'No purpose specified')}</p>
                  <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                    <div>${getStatusBadge(req.status)}</div>
                    ${req.returnDate ? `<div class="d-flex align-items-center gap-1" style="font-size: 13px; color: #64748b;"><i class="bi bi-calendar3"></i> <span>${req.returnDate}</span></div>` : ''}
                    ${req.startTime && req.endTime ? `<div class="d-flex align-items-center gap-1" style="font-size: 13px; color: #64748b;"><i class="bi bi-clock"></i> <span>${formatTime(req.startTime)} - ${formatTime(req.endTime)}</span></div>` : ''}
                  </div>
                  ${cancellationInfo}
                  ${reviewInfo}
                  <div class="d-flex gap-2">
                    ${cancelButton}
                    ${reviewButton}
                  </div>
                </div>
                <div class="text-end ms-3">
                  <div class="badge bg-light text-dark" style="font-size: 11px; font-weight: 500; padding: 6px 10px;">${date}</div>
                </div>
              </div>
            </div>
          `;
        });
        requestsDiv.innerHTML = html;
        
        // Attach event listeners to cancel buttons
        document.querySelectorAll('.cancel-request-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const requestId = this.getAttribute('data-request-id');
            const equipmentId = this.getAttribute('data-equipment-id');
            const equipmentName = this.getAttribute('data-equipment-name');
            openCancelRequestModal(requestId, equipmentId, equipmentName);
          });
        });
        
        // Attach event listeners to review buttons
        document.querySelectorAll('.review-request-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const requestId = this.getAttribute('data-request-id');
            const equipmentId = this.getAttribute('data-equipment-id');
            const equipmentName = this.getAttribute('data-equipment-name');
            openReviewModal(requestId, equipmentId, equipmentName);
          });
        });
      } catch (error) {
        console.error("Error loading requests:", error);
        requestsDiv.innerHTML = '<p class="text-danger">Error loading requests</p>';
      }
    }

    // Load Profile
    async function loadProfile() {
      const profileDiv = document.getElementById("profileContent");
      if (!profileDiv) {
        console.error("Profile content div not found");
        return;
      }
      
      if (!borrowerId) {
        profileDiv.innerHTML = '<p class="text-danger">Error: Borrower ID not found. Please log in again.</p>';
        return;
      }
      
      // Show loading state
      profileDiv.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading profile...</p></div>';
      
      try {
        console.log("Loading profile for borrowerId:", borrowerId);
        const data = await BorrowersAPI.getById(borrowerId);
        
        if (!data) {
          profileDiv.innerHTML = '<p class="text-danger">Profile not found</p>';
          return;
        }
        
        console.log("Profile data loaded:", data);
        const html = `
          <div class="row g-4">
            <div class="col-md-6">
              <div class="bg-white p-4 rounded-3 shadow-sm border-0" style="border-top: 3px solid #3b82f6 !important;">
                <div class="d-flex align-items-center mb-4">
                  <div class="me-3" style="width: 4px; height: 32px; background: linear-gradient(180deg, #3b82f6, #2563eb); border-radius: 2px;"></div>
                  <h5 class="fw-bold mb-0" style="font-size: 18px;">Profile Information</h5>
                </div>
                <div class="profile-info-list">
                  <div class="profile-info-item">
                    <div class="profile-info-label">
                      <i class="bi bi-person-badge me-2"></i>Student ID
                    </div>
                    <div class="profile-info-value">${escapeHtml(borrowerId)}</div>
                  </div>
                  <div class="profile-info-item">
                    <div class="profile-info-label">
                      <i class="bi bi-person me-2"></i>Name
                    </div>
                    <div class="profile-info-value">${escapeHtml(data.name || 'Not set')}</div>
                  </div>
                  <div class="profile-info-item">
                    <div class="profile-info-label">
                      <i class="bi bi-envelope me-2"></i>Email
                    </div>
                    <div class="profile-info-value">${escapeHtml(data.email || 'Not set')}</div>
                  </div>
                  <div class="profile-info-item">
                    <div class="profile-info-label">
                      <i class="bi bi-book me-2"></i>Course
                    </div>
                    <div class="profile-info-value">${escapeHtml(data.course || 'Not set')}</div>
                  </div>
                  <div class="profile-info-item">
                    <div class="profile-info-label">
                      <i class="bi bi-calendar3 me-2"></i>Year Level
                    </div>
                    <div class="profile-info-value">${escapeHtml(data.yearLevel || 'Not set')}</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-white p-4 rounded-3 shadow-sm border-0" style="border-top: 3px solid #10b981 !important;">
                <div class="d-flex align-items-center mb-4">
                  <div class="me-3" style="width: 4px; height: 32px; background: linear-gradient(180deg, #10b981, #059669); border-radius: 2px;"></div>
                  <h5 class="fw-bold mb-0" style="font-size: 18px;">Account Statistics</h5>
                </div>
                <div id="profileStats">
                  <p class="text-muted">Loading statistics...</p>
                </div>
              </div>
            </div>
          </div>
        `;
        profileDiv.innerHTML = html;

        // Load profile stats
        const requests = await RequestsAPI.getAll({ borrowerId: borrowerId });
        
        let pending = 0, approved = 0, rejected = 0;
        requests.forEach(req => {
          const status = (req.status || '').toLowerCase();
          if (status.includes('pending')) pending++;
          else if (status.includes('approved') || status.includes('active')) approved++;
          else if (status.includes('rejected') || status.includes('denied')) rejected++;
        });

        document.getElementById("profileStats").innerHTML = `
          <div class="profile-stats-list">
            <div class="profile-stat-item">
              <div class="profile-stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                <i class="bi bi-file-earmark-text"></i>
              </div>
              <div class="profile-stat-content">
                <div class="profile-stat-label">Total Requests</div>
                <div class="profile-stat-value">${requests.length}</div>
              </div>
            </div>
            <div class="profile-stat-item">
              <div class="profile-stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <i class="bi bi-clock-history"></i>
              </div>
              <div class="profile-stat-content">
                <div class="profile-stat-label">Pending</div>
                <div class="profile-stat-value">${pending}</div>
              </div>
            </div>
            <div class="profile-stat-item">
              <div class="profile-stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="profile-stat-content">
                <div class="profile-stat-label">Approved</div>
                <div class="profile-stat-value">${approved}</div>
              </div>
            </div>
            <div class="profile-stat-item">
              <div class="profile-stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <i class="bi bi-x-circle"></i>
              </div>
              <div class="profile-stat-content">
                <div class="profile-stat-label">Rejected</div>
                <div class="profile-stat-value">${rejected}</div>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error("Error loading profile:", error);
        let errorMessage = "Error loading profile";
        if (error.message) {
          errorMessage += ": " + error.message;
        }
        profileDiv.innerHTML = `<p class="text-danger">${errorMessage}</p>`;
      }
    }

    function getStatusBadge(status) {
      const statusLower = (status || 'pending').toLowerCase();
      let badgeClass = 'bg-secondary';
      if (statusLower.includes('approved') || statusLower.includes('active')) badgeClass = 'bg-success';
      else if (statusLower.includes('pending')) badgeClass = 'bg-warning';
      else if (statusLower.includes('rejected') || statusLower.includes('denied') || statusLower.includes('cancelled')) badgeClass = 'bg-danger';
      
      return `<span class="badge ${badgeClass} badge-status">${status || 'Pending'}</span>`;
    }

    // Load Analytics
    async function loadAnalytics() {
      const analyticsDiv = document.getElementById("analyticsContent");
      analyticsDiv.innerHTML = '<div class="loading"><div class="spinner-border text-primary" role="status"></div></div>';

      try {
        const requests = await RequestsAPI.getAll({ borrowerId: borrowerId });
        const equipment = await EquipmentAPI.getAll();
        
        // Calculate statistics
        const totalRequests = requests.length;
        const approvedRequests = requests.filter(r => (r.status || '').toLowerCase().includes('approved') || (r.status || '').toLowerCase().includes('active')).length;
        const rejectedRequests = requests.filter(r => (r.status || '').toLowerCase().includes('rejected') || (r.status || '').toLowerCase().includes('denied')).length;
        const successRate = totalRequests > 0 ? Math.round((approvedRequests / totalRequests) * 100) : 0;
        
        // Most borrowed equipment
        const equipmentCounts = {};
        requests.forEach(req => {
          if (req.equipmentName) {
            equipmentCounts[req.equipmentName] = (equipmentCounts[req.equipmentName] || 0) + 1;
          }
        });
        const mostBorrowed = Object.entries(equipmentCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .map(([name, count]) => ({ name, count }));

        const html = `
          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <div class="analytics-card">
                <div class="analytics-stat">
                  <div class="analytics-stat-label">Total Requests</div>
                  <div class="analytics-stat-value">${totalRequests}</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="analytics-card">
                <div class="analytics-stat">
                  <div class="analytics-stat-label">Approved Requests</div>
                  <div class="analytics-stat-value" style="color: #10b981;">${approvedRequests}</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row g-4">
            <div class="col-md-6">
              <div class="analytics-card">
                <div class="d-flex align-items-center mb-4">
                  <div class="me-3" style="width: 4px; height: 32px; background: linear-gradient(180deg, #3b82f6, #2563eb); border-radius: 2px;"></div>
                  <h5 class="fw-bold mb-0" style="font-size: 18px;">Most Borrowed Equipment</h5>
                </div>
                ${mostBorrowed.length > 0 ? `
                  <div class="list-group">
                    ${mostBorrowed.map((item, index) => `
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                          <span class="badge bg-primary me-2">#${index + 1}</span>
                          <strong>${escapeHtml(item.name)}</strong>
                        </div>
                        <span class="badge bg-secondary">${item.count} ${item.count === 1 ? 'time' : 'times'}</span>
                      </div>
                    `).join('')}
                  </div>
                ` : '<p class="text-muted">No equipment borrowed yet.</p>'}
              </div>
            </div>
            <div class="col-md-6">
              <div class="analytics-card">
                <div class="d-flex align-items-center mb-4">
                  <div class="me-3" style="width: 4px; height: 32px; background: linear-gradient(180deg, #10b981, #059669); border-radius: 2px;"></div>
                  <h5 class="fw-bold mb-0" style="font-size: 18px;">Request Statistics</h5>
                </div>
                <div class="profile-stats-list">
                  <div class="profile-stat-item">
                    <div class="profile-stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                      <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="profile-stat-content">
                      <div class="profile-stat-label">Approved</div>
                      <div class="profile-stat-value">${approvedRequests}</div>
                    </div>
                  </div>
                  <div class="profile-stat-item">
                    <div class="profile-stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                      <i class="bi bi-x-circle"></i>
                    </div>
                    <div class="profile-stat-content">
                      <div class="profile-stat-label">Rejected</div>
                      <div class="profile-stat-value">${rejectedRequests}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        analyticsDiv.innerHTML = html;
      } catch (error) {
        console.error("Error loading analytics:", error);
        analyticsDiv.innerHTML = '<p class="text-danger">Error loading analytics</p>';
      }
    }

    // Open Cancel Request Modal
    function openCancelRequestModal(requestId, equipmentId, equipmentName) {
      document.getElementById("cancelRequestId").value = requestId;
      document.getElementById("cancelEquipmentId").value = equipmentId;
      document.getElementById("cancelEquipmentName").value = equipmentName;
      document.getElementById("cancelEquipmentDisplay").value = equipmentName;
      document.getElementById("cancelReason").value = '';
      const modal = new bootstrap.Modal(document.getElementById("cancelRequestModal"));
      modal.show();
    }

    // Open Review Modal
    function openReviewModal(requestId, equipmentId, equipmentName) {
      document.getElementById("reviewRequestId").value = requestId;
      document.getElementById("reviewEquipmentId").value = equipmentId;
      document.getElementById("reviewEquipmentName").value = equipmentName;
      document.getElementById("reviewEquipmentDisplay").value = equipmentName;
      document.getElementById("reviewComment").value = '';
      
      const modal = new bootstrap.Modal(document.getElementById("reviewModal"));
      modal.show();
    }


    // Review Form Submission
    document.getElementById("reviewForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const requestId = document.getElementById("reviewRequestId").value;
      const equipmentId = document.getElementById("reviewEquipmentId").value;
      const comment = document.getElementById("reviewComment").value.trim();

      if (!comment) {
        showAlert("Please provide your feedback.", "warning");
        return;
      }

      try {
        // Submit review via API
        const result = await RequestsAPI.submitReview(requestId, {
          comment: comment,
          equipmentId: equipmentId,
          timestamp: new Date().toISOString()
        });

        showAlert("Feedback submitted successfully!", "success");
        
        const modal = bootstrap.Modal.getInstance(document.getElementById("reviewModal"));
        modal.hide();
        
        document.getElementById("reviewForm").reset();
        
        // Clear cache and reload (including borrower cache since trust points changed)
        clearCache('requests');
        clearCache('borrower'); // Clear borrower cache to refresh trust points
        clearCache('stats');
        await Promise.all([
          loadMyRequests(),
          loadDashboardStats() // Reload stats to show updated trust points
        ]);
      } catch (error) {
        console.error("Error submitting feedback:", error);
        let errorMessage = "Error submitting feedback. Please try again.";
        if (error.message) {
          errorMessage = error.message;
        }
        // Log full error for debugging
        console.error("Full error details:", error);
        showAlert(errorMessage, "danger");
      }
    });

    // Cancel Request Form
    document.getElementById("cancelRequestForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const requestId = document.getElementById("cancelRequestId").value;
      const equipmentId = document.getElementById("cancelEquipmentId").value;
      const cancellationComment = document.getElementById("cancelReason").value;

      if (!cancellationComment.trim()) {
        showAlert("Please provide a reason for cancelling the request.", "warning");
        return;
      }

      try {
        // Cancel request via API
        await RequestsAPI.cancel(requestId, cancellationComment);

        // If equipment status was changed due to this request, we might want to revert it
        // However, for pending requests, equipment status should still be "Available"
        // So we don't need to update equipment status here
        
        showAlert("Request cancelled successfully.", "success");
        
        const modal = bootstrap.Modal.getInstance(document.getElementById("cancelRequestModal"));
        modal.hide();
        
        document.getElementById("cancelRequestForm").reset();
        
        // Clear cache and reload in parallel
        clearCache('requests');
        clearCache('stats');
        await Promise.all([
          loadMyRequests(),
          loadDashboardStats(),
          loadRecentRequests()
        ]);
      } catch (error) {
        console.error("Error cancelling request:", error);
        const errorMessage = error.message || "Error cancelling request. Please try again.";
        showAlert(errorMessage, "danger");
      }
    });

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Format time from 24-hour format (HH:mm) to 12-hour format (h:mm AM/PM)
    function formatTime(time24) {
      if (!time24) return '';
      const [hours, minutes] = time24.split(':');
      const hour = parseInt(hours, 10);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      return `${hour12}:${minutes} ${ampm}`;
    }

    // Notifications Management
    // Load and Display Notifications
    async function loadNotifications() {
      try {
        notifications = await NotificationsAPI.getAll();
        displayNotifications();
        updateNotificationBadge();
      } catch (error) {
        console.error('Error loading notifications:', error);
        const notificationsList = document.getElementById('notificationsList');
        if (notificationsList) {
          notificationsList.innerHTML = '<div class="notification-item"><p class="text-danger text-center mb-0">Error loading notifications</p></div>';
        }
      }
    }

    // Display Notifications
    function displayNotifications() {
      const notificationsList = document.getElementById('notificationsList');
      if (!notificationsList) return;

      if (notifications.length === 0) {
        notificationsList.innerHTML = '<div class="notification-item"><p class="text-muted text-center mb-0">No notifications</p></div>';
        return;
      }

      // Sort by timestamp (newest first)
      const sortedNotifications = [...notifications].sort((a, b) => {
        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
        return timeB - timeA;
      });

      let html = '';
      sortedNotifications.forEach(notification => {
        const date = notification.timestamp 
          ? new Date(notification.timestamp).toLocaleString('en-US', {
              month: 'short',
              day: 'numeric',
              hour: 'numeric',
              minute: '2-digit'
            })
          : 'Just now';
        
        let message = '';
        let data = {};
        try {
          data = typeof notification.data === 'string' ? JSON.parse(notification.data) : notification.data;
        } catch (e) {
          data = notification.data || {};
        }
        
        if (notification.type === 'request_approved') {
          message = `Your request for "${data.equipmentName || 'equipment'}" has been approved!`;
        } else if (notification.type === 'request_rejected') {
          message = `Your request for "${data.equipmentName || 'equipment'}" has been rejected.`;
        } else if (notification.type === 'equipment_returned') {
          message = `Equipment "${data.equipmentName || 'equipment'}" has been returned. Please leave a review!`;
        } else {
          message = 'New notification';
        }

        html += `
          <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="handleNotificationClick('${notification.id}')">
            <p class="mb-1">${escapeHtml(message)}</p>
            <small class="notification-time">${date}</small>
          </div>
        `;
      });

      notificationsList.innerHTML = html;
    }

    // Handle Notification Click
    async function handleNotificationClick(notificationId) {
      try {
        await NotificationsAPI.markAsRead(notificationId);
        await loadNotifications();
        
        // Navigate to requests section if it's a request-related notification
        const notification = notifications.find(n => n.id === notificationId);
        if (notification && (notification.type === 'request_approved' || notification.type === 'request_rejected' || notification.type === 'equipment_returned')) {
          switchSection('requests');
        }
        
        // Close dropdown
        const dropdown = document.getElementById('notificationsDropdown');
        if (dropdown) {
          dropdown.classList.remove('show');
          dropdown.style.display = 'none';
        }
      } catch (error) {
        console.error('Error updating notification:', error);
      }
    }

    // Update Notification Badge
    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      if (!badge) return;

      const unreadCount = notifications.filter(n => !n.read).length;
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }

    // Mark All as Read
    document.getElementById('markAllReadBtn').addEventListener('click', async (e) => {
      e.stopPropagation();
      try {
        await NotificationsAPI.markAllAsRead();
        await loadNotifications();
      } catch (error) {
        console.error('Error marking all as read:', error);
        showAlert('Error marking notifications as read', 'danger');
      }
    });

    // Notification Icon Click
    const notificationIcon = document.getElementById('notificationIcon');
    if (notificationIcon) {
      notificationIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        const dropdown = document.getElementById('notificationsDropdown');
        if (dropdown) {
          // Toggle dropdown visibility
          if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
          } else {
            dropdown.classList.add('show');
            dropdown.style.display = 'block';
            loadNotifications(); // Load notifications when opening
          }
        }
      });
    }

    // Close notifications when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('notificationsDropdown');
      const icon = document.getElementById('notificationIcon');
      const iconWrapper = document.querySelector('.notification-icon-wrapper');
      
      if (dropdown && icon) {
        // Check if click is outside both icon and dropdown
        if (!dropdown.contains(e.target) && !icon.contains(e.target) && (!iconWrapper || !iconWrapper.contains(e.target))) {
          dropdown.classList.remove('show');
          dropdown.style.display = 'none';
        }
      }
    });

    // Real-time Notification Polling
    function startNotificationPolling() {
      // Poll every 60 seconds for new notifications (reduced from 10s to save Edge Requests)
      notificationPollInterval = setInterval(async () => {
        try {
          const currentNotifications = await NotificationsAPI.getAll();
          const unreadCount = currentNotifications.filter(n => !n.read).length;
          
          // Update notification badge
          updateNotificationBadge();
          
          // Update notifications array if dropdown is open
          const dropdown = document.getElementById('notificationsDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            notifications = currentNotifications;
            displayNotifications();
          }
          
          // Check for status changes in requests
          if (lastNotificationCheck) {
            const newNotifications = currentNotifications.filter(n => 
              new Date(n.timestamp) > lastNotificationCheck && !n.read
            );
            
            if (newNotifications.length > 0) {
              // Show toast for new notifications
              newNotifications.forEach(notif => {
                const notifData = typeof notif.data === 'string' ? JSON.parse(notif.data) : notif.data;
                if (notif.type === 'request_approved') {
                  showAlert(`Your request for "${notifData.equipmentName || 'equipment'}" has been approved!`, 'success');
                } else if (notif.type === 'request_rejected') {
                  showAlert(`Your request for "${notifData.equipmentName || 'equipment'}" has been rejected.`, 'warning');
                } else if (notif.type === 'equipment_returned') {
                  showAlert(`Equipment "${notifData.equipmentName || 'equipment'}" has been returned. Please leave a review!`, 'info');
                }
              });
              
              // Reload requests if we're on the requests section
              const activeSection = document.querySelector('.section.active');
              if (activeSection && activeSection.id === 'requestsSection') {
                await loadMyRequests();
              }
            }
          }
          
          notifications = currentNotifications;
          lastNotificationCheck = new Date();
        } catch (error) {
          console.error('Error polling notifications:', error);
        }
      }, 10000); // Poll every 10 seconds
    }

    function stopNotificationPolling() {
      if (notificationPollInterval) {
        clearInterval(notificationPollInterval);
        notificationPollInterval = null;
      }
    }

    // Load initial notification count
    async function loadInitialNotifications() {
      try {
        notifications = await NotificationsAPI.getAll();
        updateNotificationBadge();
      } catch (error) {
        console.error('Error loading initial notifications:', error);
      }
    }

    // Initial load
    window.addEventListener("load", async () => {
      // Initialize barcode scanner
      initializeBarcodeScanner();
      
      // Clear all caches on page load to ensure fresh data (especially trust points)
      clearCache();
      
      // Load initial notification count
      await loadInitialNotifications();
      
      // Start real-time notification polling
      startNotificationPolling();
      
      const saved = localStorage.getItem('borrowerActiveSection') || 'dashboard';
      switchSection(saved);
      if (saved === 'dashboard') {
        // Load in parallel for better performance
        await Promise.all([
          loadDashboardStats(),
          loadRecentRequests()
        ]);
      }
    });
  </script>
</body>
</html>

